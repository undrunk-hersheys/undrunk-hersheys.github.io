---
layout: post
title:  "stm32f103c8t6_fw"
date:   2025-03-01 18:53:00 +0900
categories: embedded
---

For the minimum file needed. -essential 
main.c  
: contains user code  
startup.s  
: contains initial reset code [reset_handler, reset routine, interrupte vector table], copy .data section, reset .bss data, set system clock 
link_script.ld  
: reorganize memeroy and code structure. set Flash/RAM size, set boundary of .text, .data, .bss, stack/heap.  
  
so for the firmware level design, those three files are nessasary.  
  
-not essentail but need to be there for the printf / malloc  
systemcalls.c
:when printf(), scanf() is used, need to call the system (_write, _read). But eversince embedded system do not have the OS, we need to define by ourselves. So by using UART to use printf(), need to implement _write().  

```
int _write(int file, char *ptr, int len) {
    for (int i = 0; i < len; i++) {
        USART_SendChar(ptr[i]); // send UART
    }
    return len;
}
```


So when the MCU is powered on, scpu start in the certain address (reset vector). Initialize reset memory, set system. Execute main(), while(1).  
What is interrupt vector table, reset routine?  
  
Interrupt Vector Table (IVT)  
: a tabel showing where the MCU should start. It is literally bunch of data table containing events like reset, interrupt is located. 

| Adress        | Words           | eg  |
| ------------- |:-------------:| -----:|
| 0x08000000	| Stack Pointer | $0x20002000 |
| 0x08000004    | Reset Handler | Reset_Handler() |
| 0x08000008    | NMI           | NMI_Handler() |
  
MSP (main stack pointer) gives the end of RAM (start of stack) in general.  
Reset Handler is where the first code locates.  



auto generated main.c  
general format:  
```
/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>

#if !defined(__SOFT_FP__) && defined(__ARM_FP)
  #warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

int main(void)
{
    /* Loop forever */
	for(;;);
}
```
  
But here, will going to make new main.c  


HAL Driver:  
when controlling MCU like STM32, need to control GPIO, UART,  I2c, SPI, ADC, etc  
But controlling it by using hw register is too complicated, and easily cause errors.  
Therefore, we use HAL driver which controls registers by own.  

when not using HAL  
```
RCC->AHB1ENR |= (1 << 0);     // GPIOA clock
GPIOA->MODER &= ~(3 << (5 * 2)); // MODER5 reset
GPIOA->MODER |= (1 << (5 * 2));  // MODER5 as out
GPIOA->ODR |= (1 << 5);      // GPIOA 5 set HIGH
```

when using HAL
```
HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_SET);
```

So easier to code, officially provdied by the ST, but may slower bit compare not using since it is higher API.  
This HAL driver will be located in the lib dir.  

